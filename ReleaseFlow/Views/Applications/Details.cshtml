@model ReleaseFlow.Models.Application
@{
    ViewData["Title"] = Model.Name;
}

<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="bi bi-app-indicator"></i> @Model.Name</h2>
        <p class="text-muted">@Model.Description</p>
    </div>
    <div class="col-md-4 text-end">
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-secondary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Application Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th width="40%">Name:</th>
                        <td><strong>@Model.Name</strong></td>
                    </tr>
                    <tr>
                        <th>Environment:</th>
                        <td>
                            @if (Model.Environment == "Production")
                            {
                                <span class="badge bg-danger">@Model.Environment</span>
                            }
                            else if (Model.Environment == "Staging")
                            {
                                <span class="badge bg-warning">@Model.Environment</span>
                            }
                            else
                            {
                                <span class="badge bg-info">@Model.Environment</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <th>IIS Site:</th>
                        <td><code>@Model.IISSiteName</code></td>
                    </tr>
                    <tr>
                        <th>Application Path:</th>
                        <td><code class="text-primary">@Model.ApplicationPath</code></td>
                    </tr>
                    <tr>
                        <th>App Pool:</th>
                        <td><code>@Model.AppPoolName</code></td>
                    </tr>
                    <tr>
                        <th>Physical Path:</th>
                        <td><small>@Model.PhysicalPath</small></td>
                    </tr>
                    <tr>
                        <th>Health Check URL:</th>
                        <td>
                            @if (!string.IsNullOrEmpty(Model.HealthCheckUrl))
                            {
                                <a href="@Model.HealthCheckUrl" target="_blank">@Model.HealthCheckUrl</a>
                            }
                            else
                            {
                                <span class="text-muted">Not configured</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <th>Created:</th>
                        <td>@Model.CreatedAt.ToLocalTime().ToString("g")</td>
                    </tr>
                    @if (Model.UpdatedAt.HasValue)
                    {
                        <tr>
                            <th>Last Updated:</th>
                            <td>@Model.UpdatedAt.Value.ToLocalTime().ToString("g")</td>
                        </tr>
                    }
                </table>

                <div class="d-grid gap-2 mt-3">
                    <a asp-controller="Deployments" asp-action="Deploy" asp-route-applicationId="@Model.Id" class="btn btn-primary">
                        <i class="bi bi-cloud-upload"></i> Deploy New Version
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Deployments</h5>
            </div>
            <div class="card-body">
                @if (Model.Deployments != null && Model.Deployments.Any())
                {
                    <div class="list-group">
                        @foreach (var deployment in Model.Deployments.OrderByDescending(d => d.StartedAt).Take(10))
                        {
                            <a asp-controller="Deployments" asp-action="Details" asp-route-id="@deployment.Id" 
                               class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Version @deployment.Version</h6>
                                    <small>
                                        @if (deployment.Status == ReleaseFlow.Models.DeploymentStatus.Succeeded)
                                        {
                                            <span class="badge bg-success">Success</span>
                                        }
                                        else if (deployment.Status == ReleaseFlow.Models.DeploymentStatus.Failed)
                                        {
                                            <span class="badge bg-danger">Failed</span>
                                        }
                                        else if (deployment.Status == ReleaseFlow.Models.DeploymentStatus.InProgress)
                                        {
                                            <span class="badge bg-warning">In Progress</span>
                                        }
                                        else if (deployment.Status == ReleaseFlow.Models.DeploymentStatus.RolledBack)
                                        {
                                            <span class="badge bg-secondary">Rolled Back</span>
                                        }
                                    </small>
                                </div>
                                <small class="text-muted">@deployment.StartedAt.ToLocalTime().ToString("g")</small>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted text-center py-4">
                        No deployments yet
                        <br />
                        <a asp-controller="Deployments" asp-action="Deploy" asp-route-applicationId="@Model.Id" class="btn btn-sm btn-primary mt-2">
                            <i class="bi bi-cloud-upload"></i> Deploy Now
                        </a>
                    </p>
                }
            </div>
        </div>
    </div>

    <!-- File Structure Section -->
    <div class="col-md-12 mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-folder-tree me-2"></i>Deployed File Structure
                </h5>
                <button id="refreshFileTree" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="fileTreeContainer" style="max-height: 600px; overflow-y: auto;">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading file structure...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let fileTreeData = null;

    function loadFileTree() {
        const container = document.getElementById('fileTreeContainer');
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="text-muted mt-2">Loading file structure...</p></div>';

        fetch('@Url.Action("GetFileStructure", "Applications", new { id = Model.Id })')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
                } else {
                    fileTreeData = data;
                    container.innerHTML = renderTree(data);
                    attachTreeEvents();
                }
            })
            .catch(error => {
                container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error loading file structure: ${error.message}</div>`;
            });
    }

    function renderTree(node, level = 0) {
        if (node.type === 'error') {
            return `<div class="text-danger ms-${level * 3}"><i class="bi bi-exclamation-circle"></i> ${node.name}</div>`;
        }

        if (node.type === 'limit') {
            return `<div class="text-muted ms-${level * 3}"><i class="bi bi-three-dots"></i> ${node.name}</div>`;
        }

        let html = '';
        
        if (node.type === 'directory') {
            const hasChildren = node.children && node.children.length > 0;
            const icon = hasChildren ? 'bi-folder-fill' : 'bi-folder';
            const toggleIcon = hasChildren ? 'bi-chevron-right' : '';
            
            html += `<div class="tree-node" data-level="${level}">`;
            html += `<div class="tree-item d-flex align-items-center py-1" style="padding-left: ${level * 20}px; cursor: ${hasChildren ? 'pointer' : 'default'};">`;
            if (hasChildren) {
                html += `<i class="bi ${toggleIcon} tree-toggle me-1" style="font-size: 0.8rem;"></i>`;
            } else {
                html += `<span style="width: 13px; display: inline-block;"></span>`;
            }
            html += `<i class="bi ${icon} text-warning me-2"></i>`;
            html += `<span class="fw-bold">${node.name}</span>`;
            html += `</div>`;
            
            if (hasChildren) {
                html += `<div class="tree-children" style="display: none;">`;
                node.children.forEach(child => {
                    html += renderTree(child, level + 1);
                });
                html += `</div>`;
            }
            html += `</div>`;
        } else if (node.type === 'file') {
            const icon = getFileIcon(node.name);
            html += `<div class="tree-node" data-level="${level}">`;
            html += `<div class="tree-item d-flex align-items-center justify-content-between py-1" style="padding-left: ${level * 20 + 13}px;">`;
            html += `<div><i class="bi ${icon} me-2"></i><span>${node.name}</span></div>`;
            html += `<div class="text-muted small">${node.size} <span class="ms-2">${node.modified}</span></div>`;
            html += `</div>`;
            html += `</div>`;
        }
        
        return html;
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'dll': 'bi-file-earmark-binary text-secondary',
            'exe': 'bi-file-earmark-binary text-primary',
            'config': 'bi-file-earmark-code text-info',
            'json': 'bi-file-earmark-code text-warning',
            'xml': 'bi-file-earmark-code text-success',
            'cs': 'bi-file-earmark-code text-primary',
            'cshtml': 'bi-file-earmark-code text-danger',
            'js': 'bi-file-earmark-code text-warning',
            'css': 'bi-file-earmark-code text-info',
            'html': 'bi-file-earmark-code text-danger',
            'txt': 'bi-file-earmark-text',
            'log': 'bi-file-earmark-text text-muted',
            'zip': 'bi-file-earmark-zip text-warning',
            'pdf': 'bi-file-earmark-pdf text-danger',
            'png': 'bi-file-earmark-image text-primary',
            'jpg': 'bi-file-earmark-image text-primary',
            'jpeg': 'bi-file-earmark-image text-primary',
            'gif': 'bi-file-earmark-image text-primary',
            'svg': 'bi-file-earmark-image text-success'
        };
        return iconMap[ext] || 'bi-file-earmark';
    }

    function attachTreeEvents() {
        document.querySelectorAll('.tree-item').forEach(item => {
            const parent = item.parentElement;
            const children = parent.querySelector('.tree-children');
            const toggle = item.querySelector('.tree-toggle');
            
            if (children && toggle) {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isExpanded = children.style.display !== 'none';
                    children.style.display = isExpanded ? 'none' : 'block';
                    toggle.classList.toggle('bi-chevron-right', isExpanded);
                    toggle.classList.toggle('bi-chevron-down', !isExpanded);
                });
            }
        });
    }

    // Load tree on page load
    document.addEventListener('DOMContentLoaded', loadFileTree);

    // Refresh button
    document.getElementById('refreshFileTree').addEventListener('click', loadFileTree);
</script>

<style>
    .tree-item:hover {
        background-color: #f8f9fa;
    }
    
    .tree-toggle {
        transition: transform 0.2s;
    }
</style>
}
